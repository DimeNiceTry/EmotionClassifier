# Настройка и запуск RabbitMQ и ML-воркеров

## Требования

Для работы системы необходимы:
- Python 3.7+
- RabbitMQ сервер
- PostgreSQL

## Установка зависимостей

1. Установите необходимые зависимости:
```bash
pip install -r requirements.txt
```

## Запуск инфраструктуры в Docker

Для удобства разработки и тестирования можно запустить всю необходимую инфраструктуру в Docker:

1. Убедитесь, что у вас установлен Docker и Docker Compose
2. Запустите сервисы с помощью Docker Compose:
```bash
cd deployment
docker-compose up -d
```

Это запустит:
- PostgreSQL (порт 5432)
- RabbitMQ (порт 5672, веб-интерфейс на порту 15672)
- Веб-приложение
- Nginx прокси

Веб-интерфейс RabbitMQ будет доступен по адресу: http://localhost:15672/
- Логин: guest
- Пароль: guest

## Запуск всех сервисов

Для запуска всех компонентов системы (API, Telegram-бот, ML-воркеры) используйте команду:

```bash
python start_services.py
```

Вы можете настроить количество ML-воркеров с помощью параметра `--workers`:

```bash
python start_services.py --workers 5
```

Можно запустить только определенные компоненты:

```bash
# Запуск без Telegram-бота
python start_services.py --no-bot

# Запуск без ML-воркеров
python start_services.py --no-workers
```

## Запуск только ML-воркеров

Для запуска только ML-воркеров используйте команду:

```bash
python -m ml_service.rabbitmq.run_workers --workers 3
```

## Тестирование системы

Для тестирования системы вы можете использовать скрипт `test_ml_api.py`:

```bash
python test_ml_api.py --username ваш_логин --password ваш_пароль --text "Текст для анализа" --count 5
```

Где:
- `--username` - имя пользователя в системе
- `--password` - пароль пользователя
- `--text` - текст для анализа (по умолчанию "Тестовое предсказание")
- `--count` - количество запросов для отправки (по умолчанию 5)

## Архитектура системы

Система состоит из следующих компонентов:

1. **FastAPI сервер** - обрабатывает REST API запросы и отправляет задачи в очередь RabbitMQ
2. **RabbitMQ** - брокер сообщений для асинхронной обработки задач
3. **ML-воркеры** - получают задачи из очереди, выполняют предсказания и сохраняют результаты
4. **Telegram-бот** - альтернативный интерфейс для взаимодействия с системой
5. **PostgreSQL** - хранение данных пользователей, транзакций и результатов предсказаний

## Принцип работы

1. Пользователь отправляет запрос через REST API или Telegram-бот
2. Запрос проверяется на валидность и создается запись в базе данных
3. Задача отправляется в очередь RabbitMQ
4. Один из доступных ML-воркеров получает задачу из очереди
5. Воркер выполняет валидацию данных, обработку и предсказание
6. Результат сохраняется в базу данных
7. Пользователь может проверить статус задачи и получить результат 